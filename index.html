<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾ˆçµ†ä¹‹æ£® | å¥‘ç´„ç°½è¨‚</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #4CAF50; --gold: #FFD700; --bg: #fcfbf5; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* é é¢åˆ‡æ› */
        .page { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; transition: opacity 0.5s; }
        .page.active { display: flex; opacity: 1; }

        /* è¼‰å…¥ä¸­ */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #555; }

        /* å…¥å£é  (Landing) */
        .landing-box { margin-top: 100px; text-align: center; }
        .btn { padding: 15px 40px; font-size: 18px; border-radius: 30px; border: none; cursor: pointer; color: white; margin: 10px; font-weight: bold; transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-create { background: var(--primary); box-shadow: 0 4px 10px rgba(76,175,80,0.3); }
        .btn-invite { background: #2196F3; }

        /* å¥‘ç´„é  (Contract) */
        .contract-paper {
            background: #fff8dc; border: 4px double #8b4513; padding: 20px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 90%; text-align: center; margin-top: 20px;
            position: relative;
        }
        .triangle-container {
            position: relative; width: 260px; height: 240px; margin: 30px auto;
        }
        /* ä¸‰å€‹æŒ‡ç´‹ä½ç½®: é ‚éƒ¨, å·¦ä¸‹, å³ä¸‹ */
        .slot { position: absolute; width: 70px; height: 70px; border: 2px dashed #bcaaa4; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.5s; background: rgba(255,255,255,0.5); }
        .slot.top { top: 0; left: 50%; transform: translateX(-50%); }
        .slot.left { bottom: 0; left: 0; }
        .slot.right { bottom: 0; right: 0; }
        
        .slot img { width: 40px; height: 40px; border-radius: 50%; margin-bottom: -10px; opacity: 0.5; }
        .slot span { font-size: 10px; margin-top: 12px; color: #555; font-weight: bold; }
        
        /* ç°½ç½²å¾Œçš„ç‰¹æ•ˆ */
        .slot.signed { border-color: var(--primary); background: rgba(76,175,80,0.2); box-shadow: 0 0 15px var(--primary); border-style: solid; }
        .slot.signed img { opacity: 1; border: 2px solid var(--primary); }

        /* è‡ªå·±çš„æŒ‡ç´‹æŒ‰éˆ• */
        #my-finger-btn {
            width: 80px; height: 80px; background: radial-gradient(circle, #ff5252 0%, #d32f2f 100%);
            border-radius: 50%; border: 4px solid white; box-shadow: 0 5px 15px rgba(211,47,47,0.4);
            color: white; font-weight: bold; display: flex; justify-content: center; align-items: center;
            margin-top: 20px; user-select: none; cursor: pointer; position: relative;
        }
        #my-finger-btn.pressing { transform: scale(0.9); }
        #my-finger-btn::after { content: "é•·æŒ‰"; font-size: 14px; }
        
        /* å…‰æ•ˆ */
        @keyframes flash { 0%{opacity:0;} 50%{opacity:1;} 100%{opacity:0;} }
        .effect-flash { position: fixed; top:0; left:0; width:100%; height:100%; background: white; pointer-events: none; opacity: 0; z-index: 1000; }

    </style>
</head>
<body>

    <div id="loading">ç³»çµ±è®€å–ä¸­...</div>
    <div class="effect-flash" id="flash-overlay"></div>

    <div id="view-landing" class="page">
        <h1 style="color:#555;">ğŸŒ² ç¾ˆçµ†ä¹‹æ£®</h1>
        <p>èˆ‡å¤¥ä¼´å…±åŒç°½ç½²å¥‘ç´„ï¼Œ<br>ç¨®ä¸‹ç¿’æ…£çš„ç¨®å­ã€‚</p>
        <div class="landing-box">
            <button class="btn btn-create" onclick="createTeam()">å»ºç«‹æ–°å¥‘ç´„</button>
            <p id="invite-hint" style="font-size:12px; color:#888; margin-top:20px;">
                å¦‚æœä½ æ”¶åˆ°é‚€è«‹é€£çµï¼Œ<br>è«‹ç›´æ¥é»æ“Šé€£çµé€²å…¥ã€‚
            </button>
        </div>
    </div>

    <div id="view-contract" class="page">
        <h2>å…±ç”Ÿå¥‘ç´„æ›¸</h2>
        <div class="contract-paper">
            <p>å¥‘ç´„ç·¨è™Ÿ: <span id="display-contract-id" style="font-weight:bold; color:#8b4513;">...</span></p>
            
            <div class="triangle-container">
                <div class="slot top" id="slot-0"><span>ç­‰å¾…ä¸­</span></div>
                <div class="slot left" id="slot-1"><span>ç­‰å¾…ä¸­</span></div>
                <div class="slot right" id="slot-2"><span>ç­‰å¾…ä¸­</span></div>
                
                <svg width="260" height="240" style="position:absolute; top:0; left:0; pointer-events:none; z-index:-1;">
                    <line x1="130" y1="70" x2="35" y2="200" stroke="#bcaaa4" stroke-width="2" stroke-dasharray="5,5" />
                    <line x1="130" y1="70" x2="225" y2="200" stroke="#bcaaa4" stroke-width="2" stroke-dasharray="5,5" />
                    <line x1="35" y1="200" x2="225" y2="200" stroke="#bcaaa4" stroke-width="2" stroke-dasharray="5,5" />
                </svg>
            </div>

            <p id="status-text">ç­‰å¾…å…¨å“¡åˆ°é½Š...</p>
        </div>

        <div id="action-area" style="margin-top:20px; text-align:center;">
            <button class="btn btn-invite" onclick="shareInvite()">é‚€è«‹å¤¥ä¼´ (+)</button>
            <div id="my-finger-btn" style="display:none;"></div>
        </div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const LIFF_ID = "2008942220-OJ5cm8o7"; 
        // è¨˜å¾—æ¬Šé™è¦é–‹ ShareTargetPicker
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx4FfKBfdxLPS4DEnHhMSvQIUy0fwe5OB97o9lEpmiu1qpLKULeGWcSMiVVwGIGnGUP/exec"; 

        // --- ç‹€æ…‹ ---
        let userProfile = {};
        let currentContractId = "";
        let pollingTimer = null;

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            liff.init({ liffId: LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    startApp();
                }
            });
        };

        async function startApp() {
            const profile = await liff.getProfile();
            userProfile = { userId: profile.userId, displayName: profile.displayName, pictureUrl: profile.pictureUrl };
            
            // 1. æª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰é‚€è«‹ç¢¼ ?contract_id=123456
            const urlParams = new URLSearchParams(window.location.search);
            const inviteId = urlParams.get('contract_id');

            // 2. ç™»å…¥å¾Œç«¯ï¼Œç¢ºèªç›®å‰ç‹€æ…‹
            const loginData = await callApi("login", {});
            
            if (loginData.contractId) {
                // A. å·²ç¶“æœ‰éšŠä¼ -> ç›´æ¥é€²å…¥å¥‘ç´„é 
                enterContractPage(loginData.contractId);
            } else if (inviteId) {
                // B. æ²’éšŠä¼ + æœ‰é‚€è«‹ç¢¼ -> åŠ å…¥éšŠä¼
                await joinTeam(inviteId);
            } else {
                // C. æ²’éšŠä¼ + æ²’é‚€è«‹ç¢¼ -> é¡¯ç¤ºé¦–é  (å»ºç«‹æŒ‰éˆ•)
                showPage('view-landing');
                hideLoading();
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        // å»ºç«‹éšŠä¼
        async function createTeam() {
            showLoading();
            const res = await callApi("create_team", {});
            if (res.status === "success") {
                enterContractPage(res.contractId);
            } else {
                alert("å»ºç«‹å¤±æ•—: " + res.message);
                hideLoading();
            }
        }

        // åŠ å…¥éšŠä¼
        async function joinTeam(cid) {
            showLoading();
            const res = await callApi("join_team", { contractId: cid });
            if (res.status === "success") {
                enterContractPage(cid);
            } else {
                alert("åŠ å…¥å¤±æ•—æˆ–éšŠä¼å·²æ»¿: " + res.message);
                showPage('view-landing'); // é€€å›é¦–é 
                hideLoading();
            }
        }

        // é€²å…¥å¥‘ç´„é é¢ (å•Ÿå‹•è¼ªè©¢)
        function enterContractPage(cid) {
            currentContractId = cid;
            document.getElementById('display-contract-id').innerText = cid;
            showPage('view-contract');
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateStatus();
            // æ¯ 5 ç§’æ›´æ–°ä¸€æ¬¡ç‹€æ…‹ (Polling)
            pollingTimer = setInterval(updateStatus, 5000);
        }

        // æ›´æ–°å¥‘ç´„ç‹€æ…‹ (é¡¯ç¤ºé ­åƒèˆ‡æŒ‡ç´‹)
        async function updateStatus() {
            const res = await callApi("get_status", { contractId: currentContractId });
            if (res.status !== "success") return;

            const members = res.members; // Array of {name, pic, signed, exists}
            let iSigned = false;
            let allPresent = true;

            // æ›´æ–°ç•«é¢ä¸Šçš„ä¸‰å€‹åœˆåœˆ
            members.forEach((m, index) => {
                const slot = document.getElementById(`slot-${index}`);
                if (m.exists) {
                    slot.innerHTML = `<img src="${m.pic || 'https://via.placeholder.com/40'}"><br><span>${m.name}</span>`;
                    if (m.signed) {
                        slot.classList.add('signed');
                    } else {
                        slot.classList.remove('signed');
                    }
                    
                    // æª¢æŸ¥æ˜¯ä¸æ˜¯æˆ‘è‡ªå·±
                    if (m.name === userProfile.displayName) { // ç°¡å–®æ¯”å°ï¼Œåš´è¬¹æ‡‰æ¯”å°ID
                        if (m.signed) iSigned = true;
                    }
                } else {
                    slot.innerHTML = `<span>ç­‰å¾…åŠ å…¥</span>`;
                    slot.classList.remove('signed');
                    allPresent = false;
                }
            });

            // ç‹€æ…‹æ–‡å­—æ§åˆ¶
            const statusTxt = document.getElementById('status-text');
            const fingerBtn = document.getElementById('my-finger-btn');
            const inviteBtn = document.querySelector('.btn-invite');

            if (res.is_active) {
                statusTxt.innerText = "âœ¨ å¥‘ç´„å·²æ­£å¼ç”Ÿæ•ˆï¼ âœ¨";
                statusTxt.style.color = "#4CAF50";
                statusTxt.style.fontWeight = "bold";
                clearInterval(pollingTimer); // åœæ­¢è¼ªè©¢
                fingerBtn.style.display = 'none';
                inviteBtn.style.display = 'none';
                // é€™è£¡å¯ä»¥è·³è½‰åˆ°ä¸‹ä¸€é—œ (ç¨®æ¨¹é é¢)
                setTimeout(() => alert("å¥‘ç´„å®Œæˆï¼Œæº–å‚™é€²å…¥ç¾ˆçµ†ä¹‹æ£®..."), 1000);
            } else if (!allPresent) {
                statusTxt.innerText = "ç­‰å¾…å¤¥ä¼´åŠ å…¥ä¸­ (åˆ†äº«é€£çµ)...";
                inviteBtn.style.display = 'inline-block';
                fingerBtn.style.display = 'none';
            } else {
                statusTxt.innerText = "å…¨å“¡åˆ°é½Šï¼è«‹é•·æŒ‰æŒ‡ç´‹ç°½ç½²";
                inviteBtn.style.display = 'none';
                if (!iSigned) {
                    fingerBtn.style.display = 'flex'; // é¡¯ç¤ºæŒ‡ç´‹æŒ‰éˆ•
                } else {
                    fingerBtn.style.display = 'none';
                    statusTxt.innerText = "æ‚¨å·²ç°½ç½²ï¼Œç­‰å¾…å¤¥ä¼´ä¸­...";
                }
            }
            hideLoading();
        }

        // åˆ†äº«é‚€è«‹
        function shareInvite() {
            if (liff.isApiAvailable('shareTargetPicker')) {
                // å»ºç«‹å¸¶æœ‰åƒæ•¸çš„é€£çµ
                const inviteLink = `https://liff.line.me/${LIFF_ID}?contract_id=${currentContractId}`;
                
                liff.shareTargetPicker([
                    {
                        "type": "flex",
                        "altText": "ä¾†è‡ªç¾ˆçµ†ä¹‹æ£®çš„é‚€è«‹",
                        "contents": {
                            "type": "bubble",
                            "body": {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [
                                    { "type": "text", "text": "ğŸŒ² ç¾ˆçµ†ä¹‹æ£®", "weight": "bold", "size": "xl", "color": "#4CAF50" },
                                    { "type": "text", "text": "é‚€è«‹ä½ åŠ å…¥ç¿’æ…£é¤Šæˆå¥‘ç´„ï¼", "margin": "md" },
                                    { "type": "text", "text": `å¥‘ç´„ä»£ç¢¼: ${currentContractId}`, "size": "xs", "color": "#aaaaaa", "margin": "sm" }
                                ]
                            },
                            "footer": {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [
                                    {
                                        "type": "button",
                                        "action": { "type": "uri", "label": "æ¥å—å¥‘ç´„", "uri": inviteLink },
                                        "style": "primary"
                                    }
                                ]
                            }
                        }
                    }
                ]).catch(err => alert("åˆ†äº«å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½é€£çµ"));
            } else {
                alert("è«‹ä½¿ç”¨æ‰‹æ©Ÿç‰ˆ LINE é€²è¡Œåˆ†äº«");
            }
        }

        // æŒ‡ç´‹é•·æŒ‰é‚è¼¯
        const fingerBtn = document.getElementById('my-finger-btn');
        let pressTimer;

        fingerBtn.addEventListener('mousedown', startPress);
        fingerBtn.addEventListener('touchstart', startPress);
        fingerBtn.addEventListener('mouseup', cancelPress);
        fingerBtn.addEventListener('touchend', cancelPress);

        function startPress(e) {
            e.preventDefault();
            fingerBtn.classList.add('pressing');
            pressTimer = setTimeout(async () => {
                // é•·æŒ‰ 1.5 ç§’æˆåŠŸ
                document.getElementById('flash-overlay').style.animation = 'flash 0.5s'; // ç‰¹æ•ˆ
                showLoading();
                await callApi("sign_oath", { contractId: currentContractId });
                updateStatus(); // åˆ·æ–°
            }, 1500);
        }

        function cancelPress() {
            fingerBtn.classList.remove('pressing');
            clearTimeout(pressTimer);
        }

        // --- API å·¥å…· ---
        async function callApi(action, payload) {
            const body = { action: action, userId: userProfile.userId, displayName: userProfile.displayName, pictureUrl: userProfile.pictureUrl, ...payload };
            try {
                const res = await fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "cors", // é—œéµ
                    headers: { "Content-Type": "text/plain" }, // é¿å… OPTIONS é æª¢
                    body: JSON.stringify(body)
                });
                return await res.json();
            } catch (e) {
                console.error(e);
                return { status: "error", message: "é€£ç·šéŒ¯èª¤" };
            }
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function showLoading() { document.getElementById('loading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }

    </script>
</body>
</html>
