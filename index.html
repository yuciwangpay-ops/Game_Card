<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾ˆçµ†ä¹‹æ£® | é›™äººé¤Šæˆ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #4CAF50; --bg: #fcfbf5; --brown: #8b4513; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* é é¢å®¹å™¨è¨­å®š (ä¿®æ­£ä½ç½®å•é¡Œ) */
        .page { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; box-sizing: border-box; opacity: 0; transition: opacity 0.5s; }
        .page.active { display: flex; opacity: 1; }
        
        /* è®“å¥‘ç´„é é¢å…§å®¹å‚ç›´ç½®ä¸­åä¸Š */
        #view-contract { justify-content: center; padding-bottom: 20vh; } 
        /* éŠæˆ²é é¢å‰‡é åº•å°é½Šæ¨¹æœ¨ */
        #view-game { justify-content: flex-end; }

        /* è¼‰å…¥ç•«é¢ */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #666; }
        .spinner { width: 30px; height: 30px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;}

        /* é€šç”¨æŒ‰éˆ• */
        .btn { padding: 12px 24px; font-size: 16px; border-radius: 30px; border: none; cursor: pointer; color: white; margin: 10px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: var(--primary); }
        .btn-blue { background: #2196F3; }
        .btn-orange { background: #FF9800; }

        /* å¥‘ç´„æ›¸æ¨£å¼ */
        .contract-paper {
            background: #fff8dc; border: 3px solid var(--brown); padding: 25px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 85%; max-width: 350px; text-align: center;
            position: relative;
        }
        .duo-slots { display: flex; justify-content: space-around; margin: 30px 0; position: relative; }
        .slot { width: 70px; height: 70px; border: 2px dashed #ccc; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; background: #fff; }
        .slot img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; opacity: 0.4; }
        .slot.signed { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .slot.signed img { opacity: 1; }
        
        /* æŒ‡ç´‹æŒ‰éˆ• */
        #finger-btn {
            width: 80px; height: 80px; background: radial-gradient(circle, #ff5252, #d32f2f);
            border-radius: 50%; border: 4px solid white; box-shadow: 0 5px 15px rgba(211,47,47,0.4);
            color: white; font-weight: bold; display: flex; justify-content: center; align-items: center;
            margin: 20px auto 0; cursor: pointer; animation: pulse 2s infinite; user-select: none;
        }
        #finger-btn::after { content: "é•·æŒ‰"; }
        #finger-btn.pressing { transform: scale(0.9); animation: none; }

        /* éŠæˆ²ä¸»ç•«é¢ */
        .game-header { position: absolute; top: 20px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
        .exp-bar { background: #eee; height: 10px; border-radius: 5px; width: 100px; overflow: hidden; }
        .exp-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }
        
        .tree-area { flex-grow: 1; width: 100%; display: flex; justify-content: center; align-items: flex-end; position: relative; padding-bottom: 80px; }
        .tree { width: 150px; height: 200px; background: url('https://img.icons8.com/dusk/200/tree.png') no-repeat bottom center; background-size: contain; transition: transform 0.3s; position: relative;}
        
        /* é¢¨éˆ´ */
        .wind-chime { position: absolute; top: 20%; right: -20px; font-size: 30px; cursor: pointer; filter: drop-shadow(0 0 5px white); animation: swing 3s infinite ease-in-out; display: none; }
        .wind-chime.has-msg::after { content: "!"; position: absolute; top: 0; right: 0; background: red; color: white; width: 15px; height: 15px; font-size: 10px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        .controls { width: 100%; background: white; padding: 20px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-around; }
        .ctl-btn { display: flex; flex-direction: column; align-items: center; background: none; border: none; font-size: 12px; color: #666; cursor: pointer; }
        .ctl-icon { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 5px; transition: transform 0.1s; }
        .ctl-icon:active { transform: scale(0.9); }
        
        /* å½ˆçª— */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 80%; text-align: center; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes swing { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(10deg); } }
        @keyframes grow { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div><div>è®€å–æ£®æ—ä¸­...</div></div>

    <div id="view-landing" class="page" style="justify-content: center;">
        <h1 style="color:var(--brown);">ğŸŒ² ç¾ˆçµ†ä¹‹æ£®</h1>
        <p style="color:#666;">é›™äººç¿’æ…£é¤Šæˆå¥‘ç´„</p>
        <button class="btn btn-green" onclick="createTeam()">å»ºç«‹æ–°å¥‘ç´„</button>
        <div id="landing-msg" style="margin-top:20px; color:#aaa; font-size:12px;"></div>
    </div>

    <div id="view-contract" class="page">
        <h2 style="color:var(--brown);">å…±ç”Ÿå¥‘ç´„æ›¸</h2>
        <div class="contract-paper">
            <div style="font-size:12px; color:#888;">å¥‘ç´„ç·¨è™Ÿ</div>
            <div id="cid-display" style="font-weight:bold; font-size:20px; letter-spacing:1px; color:var(--brown);">...</div>
            
            <div class="duo-slots">
                <div class="slot" id="slot-0"><img src="" alt="A"></div> <div class="slot" id="slot-1"><img src="" alt="B"></div> </div>
            
            <p id="contract-status" style="color:#666; font-size:14px;">ç­‰å¾…å¤¥ä¼´ä¸­...</p>
            <button class="btn btn-blue" id="btn-invite" onclick="invitePartner()">é‚€è«‹å¤¥ä¼´</button>
            <div id="finger-btn" style="display:none;"></div>
        </div>
    </div>

    <div id="view-game" class="page">
        <div class="game-header">
            <div>
                <span style="font-size:12px; color:#666;">Lv. <span id="tree-lvl">1</span></span>
                <div class="exp-bar"><div class="exp-fill" id="exp-fill"></div></div>
            </div>
            <div style="display:flex; gap:5px;">
                <img id="avatar-me" src="" style="width:30px; height:30px; border-radius:50%; border:2px solid #ddd;">
                <img id="avatar-partner" src="" style="width:30px; height:30px; border-radius:50%; border:2px solid #ddd;">
            </div>
        </div>

        <div class="tree-area">
            <div class="tree" id="the-tree">
                <div class="wind-chime" id="wind-chime" onclick="readMessage()">ğŸ</div>
            </div>
        </div>

        <div class="controls">
            <button class="ctl-btn" onclick="doCheckin()">
                <div class="ctl-icon" style="background:#e3f2fd; color:#2196F3;">ğŸ’§</div>
                æ‰“å¡
            </button>
            <button class="ctl-btn" onclick="openMsgModal()">
                <div class="ctl-icon" style="background:#fce4ec; color:#E91E63;">ğŸ“</div>
                ç•™è¨€
            </button>
            <button class="ctl-btn" onclick="sendSunlight()">
                <div class="ctl-icon" style="background:#fff3e0; color:#FF9800;">â˜€ï¸</div>
                æé†’
            </button>
        </div>
    </div>

    <div id="msg-modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>å¯«çµ¦å¤¥ä¼´çš„è©±</h3>
            <textarea id="msg-input" style="width:100%; height:80px; margin:10px 0; border:1px solid #ddd; border-radius:5px; padding:5px;"></textarea>
            <button class="btn btn-green" onclick="sendMessage()">æ›ä¸Šé¢¨éˆ´</button>
        </div>
    </div>

    <script>
        // è¨­å®šå€
        const LIFF_ID = "æ‚¨çš„_LIFF_ID"; 
        const GAS_URL = "æ‚¨çš„_GAS_WEB_APP_URL";

        let user = {};
        let contractId = "";
        let polling = null;

        window.onload = () => {
            liff.init({ liffId: LIFF_ID }).then(() => {
                if(!liff.isLoggedIn()) liff.login();
                else startApp();
            });
        };

        async function startApp() {
            const profile = await liff.getProfile();
            user = { id: profile.userId, name: profile.displayName, pic: profile.pictureUrl };
            
            // æª¢æŸ¥ URL æ˜¯å¦æœ‰é‚€è«‹ç¢¼
            const params = new URLSearchParams(window.location.search);
            const inviteCid = params.get('cid');

            const res = await api("login", {});
            
            if (res.contractId) {
                contractId = res.contractId;
                // æœ‰å¥‘ç´„ï¼Œæª¢æŸ¥ç‹€æ…‹
                checkStatus();
            } else if (inviteCid) {
                // ç„¡å¥‘ç´„ + æœ‰é‚€è«‹ç¢¼ -> åŠ å…¥
                await api("join_team", { contractId: inviteCid });
                contractId = inviteCid;
                checkStatus();
            } else {
                // ç„¡å¥‘ç´„ -> é¡¯ç¤ºé¦–é 
                show("view-landing");
                hideLoading();
            }
        }

        // æ ¸å¿ƒç‹€æ…‹æª¢æŸ¥ (æ±ºå®šé¡¯ç¤ºå¥‘ç´„é é‚„æ˜¯éŠæˆ²é )
        async function checkStatus() {
            const res = await api("get_data", { contractId });
            if (res.status !== "success") return;

            if (res.is_active) {
                enterGame(res);
            } else {
                renderContract(res.members);
            }
            hideLoading();
        }

        // æ¸²æŸ“å¥‘ç´„é é¢
        function renderContract(members) {
            show("view-contract");
            document.getElementById('cid-display').innerText = contractId;
            
            const me = members.find(m => m.id === user.id) || {};
            const partner = members.find(m => m.id !== user.id);
            
            // æ¸²æŸ“é ­åƒ
            document.getElementById('slot-0').innerHTML = `<img src="${user.pic}">`;
            if (partner) {
                document.getElementById('slot-1').innerHTML = `<img src="${partner.pic}">`;
                document.getElementById('btn-invite').style.display = 'none';
            } else {
                document.getElementById('slot-1').innerHTML = `<span>?</span>`;
                document.getElementById('btn-invite').style.display = 'inline-block';
            }

            // æŒ‡ç´‹é‚è¼¯
            const fBtn = document.getElementById('finger-btn');
            const status = document.getElementById('contract-status');
            
            if (me.signed) {
                document.getElementById('slot-0').classList.add('signed');
                fBtn.style.display = 'none';
                status.innerText = partner ? (partner.signed ? "è™•ç†ä¸­..." : "ç­‰å¾…å¤¥ä¼´ç°½ç½²...") : "ç­‰å¾…å¤¥ä¼´åŠ å…¥...";
            } else {
                if (partner) {
                    status.innerText = "å¤¥ä¼´å·²å°±ä½ï¼Œè«‹ç°½ç½²å¥‘ç´„";
                    fBtn.style.display = 'flex';
                } else {
                    status.innerText = "è«‹å…ˆé‚€è«‹å¤¥ä¼´";
                    fBtn.style.display = 'none';
                }
            }
            
            // å¦‚æœé‚„æ²’é–‹å§‹ï¼Œç¹¼çºŒè¼ªè©¢
            if (!polling) polling = setInterval(checkStatus, 3000);
        }

        // æ¸²æŸ“éŠæˆ²é é¢
        function enterGame(data) {
            if (polling) clearInterval(polling);
            show("view-game");
            
            // ç¶“é©—å€¼èˆ‡ç­‰ç´š
            const exp = parseInt(data.tree_exp);
            const level = Math.floor(exp / 100) + 1;
            document.getElementById('tree-lvl').innerText = level;
            document.getElementById('exp-fill').style.width = (exp % 100) + "%";
            
            // æ¨¹çš„å¤§å°éš¨ç­‰ç´šæˆé•·
            let scale = 1 + (level * 0.05);
            document.getElementById('the-tree').style.transform = `scale(${scale})`;

            // é ­åƒç‹€æ…‹ (æ‰“å¡é¡¯ç¤ºç¶ æ¡†)
            const me = data.members.find(m => m.id === user.id);
            const partner = data.members.find(m => m.id !== user.id);
            
            const setAvatar = (elId, mem) => {
                const el = document.getElementById(elId);
                el.src = mem.pic;
                el.style.borderColor = mem.checked_in ? "#4CAF50" : "#ddd";
                el.style.opacity = mem.checked_in ? "1" : "0.6";
            };
            setAvatar('avatar-me', me);
            if(partner) setAvatar('avatar-partner', partner);

            // é¢¨éˆ´ (æœªè®€è¨Šæ¯)
            const chime = document.getElementById('wind-chime');
            chime.style.display = 'block';
            if (data.has_msg) chime.classList.add('has-msg');
            else chime.classList.remove('has-msg');

            // å…¨å‹¤çå‹µ
            if (data.today_all_clear) {
               // å¯ä»¥åœ¨é€™è£¡åŠ å…¨å‹¤ç‰¹æ•ˆ
               console.log("å…¨å“¡å·²æ‰“å¡!"); 
            }
        }

        // --- å‹•ä½œå‡½æ•¸ ---

        async function createTeam() {
            showLoading();
            const res = await api("create_team", {});
            contractId = res.contractId;
            checkStatus();
        }

        function invitePartner() {
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([{
                    "type": "flex",
                    "altText": "ç¾ˆçµ†ä¹‹æ£®é‚€è«‹",
                    "contents": {
                        "type": "bubble",
                        "body": {
                            "type": "box", "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": "ğŸŒ² ç¾ˆçµ†ä¹‹æ£®", "weight": "bold", "color": "#8b4513" },
                                { "type": "text", "text": "é‚€è«‹ä½ æˆç‚ºæˆ‘çš„å¥‘ç´„å¤¥ä¼´", "margin": "md" }
                            ]
                        },
                        "footer": {
                            "type": "box", "layout": "vertical",
                            "contents": [{ "type": "button", "action": { "type": "uri", "label": "æ¥å—å¥‘ç´„", "uri": `https://liff.line.me/${LIFF_ID}?cid=${contractId}` }, "style": "primary" }]
                        }
                    }
                }]);
            }
        }

        // æŒ‡ç´‹é•·æŒ‰
        const fBtn = document.getElementById('finger-btn');
        let timer;
        fBtn.onmousedown = fBtn.ontouchstart = (e) => {
            e.preventDefault();
            fBtn.classList.add('pressing');
            timer = setTimeout(async () => {
                showLoading();
                await api("sign_oath", { contractId });
                checkStatus();
            }, 1000);
        };
        fBtn.onmouseup = fBtn.ontouchend = () => {
            fBtn.classList.remove('pressing');
            clearTimeout(timer);
        };

        // æ‰“å¡
        async function doCheckin() {
            showLoading();
            const res = await api("checkin", { contractId });
            if (res.status === "success") {
                alert(res.bonus ? "å…¨å“¡é”æˆï¼ç²å¾—é¡å¤–çå‹µ ğŸ" : "æ‰“å¡æˆåŠŸï¼");
                checkStatus(); // åˆ·æ–°
            } else {
                alert(res.message);
                hideLoading();
            }
        }

        // ç•™è¨€ç›¸é—œ
        function openMsgModal() { document.getElementById('msg-modal').style.display = 'flex'; }
        async function sendMessage() {
            const msg = document.getElementById('msg-input').value;
            if(!msg) return;
            document.getElementById('msg-modal').style.display = 'none';
            showLoading();
            await api("send_msg", { contractId, message: msg });
            alert("é¢¨éˆ´å·²æ›ä¸Š");
            hideLoading();
        }
        async function readMessage() {
            const chime = document.getElementById('wind-chime');
            if(!chime.classList.contains('has-msg')) {
                alert("ç›®å‰æ²’æœ‰æ–°ç•™è¨€å–”");
                return;
            }
            showLoading();
            const res = await api("read_msg", { contractId });
            alert("å¤¥ä¼´èªªï¼š\n" + res.message);
            chime.classList.remove('has-msg');
            hideLoading();
        }

        // æé†’ (é™½å…‰)
        function sendSunlight() {
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([{
                    "type": "flex", "altText": "å¤¥ä¼´å‚³é€äº†é™½å…‰",
                    "contents": {
                        "type": "bubble", "body": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "â˜€ï¸ å¤¥ä¼´é€ä¾†äº†é™½å…‰", "weight": "bold" }, { "type": "text", "text": "è¨˜å¾—å›ä¾†æ¾†æ°´æ‰“å¡å–”ï¼" }] },
                        "footer": { "type": "box", "layout": "vertical", "contents": [{ "type": "button", "action": { "type": "uri", "label": "å‰å¾€æ£®æ—", "uri": `https://liff.line.me/${LIFF_ID}` }, "style": "primary" }] }
                    }
                }]);
            }
        }

        // API
        async function api(act, data) {
            const body = { action: act, userId: user.id, displayName: user.name, pictureUrl: user.pic, ...data };
            try {
                const r = await fetch(GAS_URL, { method: "POST", mode: "cors", headers: {"Content-Type": "text/plain"}, body: JSON.stringify(body) });
                return await r.json();
            } catch(e) { alert("Error: "+e); return {status:"error"}; }
        }

        function show(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function showLoading() { document.getElementById('loading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }
    </script>
</body>
</html>
