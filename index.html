<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾ˆçµ†ä¹‹æ£®</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #4CAF50; --btn-text: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background: #000; height: 100vh; overflow: hidden; }
        .page { display: none; width: 100%; height: 100%; background-size: cover; background-position: center; background-repeat: no-repeat; flex-direction: column; align-items: center; position: relative; }
        .page.active { display: flex; opacity: 1; }
        .hidden { display: none !important; }

        /* èƒŒæ™¯åœ– */
        #view-landing { background-image: url('./images/1_home.jpeg'); justify-content: center; }
        #view-contract { background-image: url('./images/2_contract.jpeg'); padding-top: 60px; }
        #view-game { background-image: url('./images/3_game.jpeg'); justify-content: space-between; padding: 40px 0; }
        #view-watering { background-image: url('./images/4_water.jpeg'); justify-content: center; }
        #view-alldone { background-image: url('./images/6_AllDone.jpeg'); justify-content: center; align-items: center; }

        /* UI å…ƒä»¶ */
        .glass-panel { background: rgba(255, 255, 255, 0.9); padding: 10px 15px; border-radius: 15px; text-align: center; backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 10px; min-width: 280px; }
        .css-btn { padding: 12px 30px; font-size: 16px; font-weight: bold; color: var(--btn-text); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-green { background: linear-gradient(135deg, #66bb6a, #43a047); }
        .btn-blue { background: linear-gradient(135deg, #42a5f5, #1e88e5); }
        .btn-gray { background: #9e9e9e; cursor: default; }

        /* éŠæˆ²ç‰©ä»¶ */
        .tree-emoji { font-size: 150px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4)); margin-bottom: 20px; transition: transform 0.3s; }
        .wind-chime { position: absolute; top: 15%; right: 10%; font-size: 50px; cursor: pointer; z-index: 10; animation: swing 3s infinite ease-in-out; }
        .chime-dot { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: red; border-radius: 50%; border: 2px solid white; display: none; }
        .chime-dot.active { display: block; }
        
        .all-done-badge { position: absolute; top: 15%; left: 10%; font-size: 50px; cursor: pointer; z-index: 10; filter: drop-shadow(0 0 10px gold); animation: bounce 2s infinite; display: none; }

        /* å…¨å“¡é”æˆæ–‡å­—å‹•ç•« */
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .celebrate-text {
            font-size: 60px; color: #fff; font-weight: bold;
            text-shadow: 0 0 20px #FFD700, 0 0 40px #FF4500;
            animation: heartbeat 2s infinite ease-in-out;
            margin-bottom: 200px; /* å¾€ä¸Šæ¨ä¸€é»ï¼Œé¿å…æ“‹ä½èƒŒæ™¯é‡é» */
        }

        /* è¦–çª— */
        #msg-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .msg-box { width: 85%; max-width: 320px; min-height: 300px; background-image: url('./images/5_window.jpeg'); background-size: 100% 100%; padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; color: #333; font-weight: bold; }
        .msg-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; opacity: 0.6; }

        /* å‹•ç•« */
        @keyframes swing { 0% { transform: rotate(10deg); } 50% { transform: rotate(-10deg); } 100% { transform: rotate(10deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes grow { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('./images/1_home.jpeg') no-repeat center center; background-size: cover; backdrop-filter: blur(8px); z-index: 3000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }

        /* é ­åƒèˆ‡æŒ‡ç´‹ */
        .duo-container { display: flex; gap: 20px; margin-top: 20px; }
        .slot { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.5); border: 2px dashed #888; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .slot img { width: 100%; height: 100%; opacity: 0.5; }
        .slot.signed { border: 3px solid #4CAF50; box-shadow: 0 0 15px #4CAF50; background: white; }
        .slot.signed img { opacity: 1; }
        .finger-zone { width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.6); background: rgba(255, 68, 68, 0.2); display: flex; justify-content: center; align-items: center; font-size: 40px; color: white; cursor: pointer; margin-top: 20px; }
        .finger-zone::after { content: "ğŸ‘†"; }
    </style>
</head>
<body>
    <div id="loading"><div style="font-size:40px; animation:grow 1s infinite alternate;">ğŸŒ±</div><p>æ£®æ—è®€å–ä¸­...</p></div>

    <div id="msg-modal">
        <div class="msg-box">
            <div class="msg-close" onclick="closeModal()">âœ•</div>
            <div id="msg-read-mode" style="display:none; text-align:center;">
                <div style="font-size:40px; margin-bottom:10px;">ğŸ</div>
                <h3>å¤¥ä¼´çš„ç•™è¨€</h3>
                <p id="msg-text-content" style="background:rgba(255,255,255,0.6); padding:10px; border-radius:10px; margin:15px 0;">...</p>
                <button class="css-btn btn-green" onclick="closeModal()">æ”¶åˆ°äº†</button>
            </div>
            <div id="msg-write-mode" style="display:none; text-align:center; width:100%;">
                <h3>âœï¸ å¯«ä¿¡çµ¦å¤¥ä¼´</h3>
                <textarea id="msg-input" style="width:100%; height:80px; margin:15px 0; border-radius:10px; padding:10px; border:1px solid #ccc;" placeholder="å¯«ä¸‹ä½ çš„å¿ƒæƒ…..."></textarea>
                <button class="css-btn btn-green" style="width:100%;" onclick="sendMsg()">æ›ä¸Šé¢¨éˆ´</button>
            </div>
        </div>
    </div>

    <div id="view-landing" class="page">
        <div class="glass-panel" style="margin-top:-100px;"><h1 style="color:#2e7d32; margin:0;">ç¾ˆçµ†ä¹‹æ£®</h1><p style="color:#555;">é›™äººç¿’æ…£é¤Šæˆ</p></div>
        <div style="position: absolute; bottom: 80px;"><button class="css-btn btn-green" onclick="createTeam()">âœ¨ å»ºç«‹å¥‘ç´„</button></div>
    </div>

    <div id="view-contract" class="page">
        <div class="glass-panel">
            <h2 style="margin:0; color:#5d4037;">å…±ç”Ÿå¥‘ç´„æ›¸</h2>
            <div style="font-size:12px; color:#888;">No. <span id="contract-id-display">...</span></div>
            <div class="duo-container"><div class="slot" id="slot-0"><img src="" alt="A"></div><div class="slot" id="slot-1"><img src="" alt="B"></div></div>
            <p id="status-text" style="color:#8b4513; font-size:14px; margin-top:15px;">è®€å–ä¸­...</p>
        </div>
        <div style="margin-top: 30px;"><button id="btn-invite" class="css-btn btn-blue hidden" onclick="shareInvite()">ğŸ“© é‚€è«‹å¤¥ä¼´</button><div id="btn-finger" class="finger-zone hidden"></div></div>
    </div>

    <div id="view-game" class="page">
        <div class="glass-panel" style="padding: 10px 20px; margin-top: 20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span><span id="level-val" style="color:#4CAF50; font-weight:bold;">Lv.0</span> ç¥æœ¨</span>
                <span>é€£çºŒ <span id="streak-val" style="color:#f57c00; font-weight:bold;">0</span> å¤©</span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:13px; border-top:1px solid #ddd; padding-top:5px;">
                <span>âš¡ èƒ½é‡: <span id="energy-val" style="color:#9c27b0; font-weight:bold;">0</span></span>
                <span style="color:#666;">å‰©é¤˜: <span id="daily-count-val" style="color:blue; font-weight:bold;">2</span> æ¬¡</span>
            </div>
        </div>

        <div style="position:relative; width:100%; flex-grow:1; display:flex; justify-content:center; align-items:flex-end;">
            <div class="wind-chime" onclick="openChime()">ğŸ<div class="chime-dot" id="chime-dot"></div></div>
            
            <div class="all-done-badge" id="all-done-badge" onclick="showAllDonePage()">ğŸ‰</div>

            <div class="tree-emoji" id="main-tree">ğŸŒ±</div>
        </div>

        <div style="margin-bottom: 50px;">
            <button id="btn-water-action" class="css-btn btn-blue" onclick="triggerWatering()" style="font-size:20px; padding: 15px 40px;">ğŸ’§ æ³¨å…¥èƒ½é‡</button>
        </div>
    </div>

    <div id="view-watering" class="page">
        <div style="text-align:center;">
            <div style="font-size:80px; animation: grow 2s infinite;">âœ¨ğŸš¿âœ¨</div>
            <h2 style="color:white; text-shadow:0 0 10px gold; margin-top:20px;">èƒ½é‡æ³¨å…¥ä¸­...</h2>
        </div>
    </div>

    <div id="view-alldone" class="page">
        <div class="celebrate-text">å…¨å“¡é”æˆ</div>
        <div style="position:absolute; bottom:50px;">
            <button class="css-btn btn-green" onclick="showPage('view-game')">å›åˆ°æ£®æ—</button>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008942220-OJ5cm8o7"; 
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx4FfKBfdxLPS4DEnHhMSvQIUy0fwe5OB97o9lEpmiu1qpLKULeGWcSMiVVwGIGnGUP/exec"; 

        let userProfile = {};
        let currentContractId = "";
        let pollingTimer = null;
        let hasUnread = false;
        let pendingMsg = "";
        let gameData = {}; 

        const TREE_EMOJIS = ["ğŸŒ±", "ğŸŒ¿", "ğŸŒ³", "ğŸŒ²"];

        window.onload = function() {
            liff.init({ liffId: LIFF_ID }).then(() => { if (!liff.isLoggedIn()) liff.login(); else startApp(); });
        };

        async function startApp() {
            try {
                const profile = await liff.getProfile();
                userProfile = { userId: profile.userId, displayName: profile.displayName };
                const params = new URLSearchParams(window.location.search);
                const inviteId = params.get('contract_id');
                const loginData = await callApi("login", {});
                if (loginData.contractId) enterContractPage(loginData.contractId);
                else if (inviteId) await joinTeam(inviteId);
                else { showPage('view-landing'); hideLoading(); }
            } catch (err) { alert(err); hideLoading(); }
        }

        async function createTeam() { showLoading(); const res = await callApi("create_team", {}); if (res.status === "success") enterContractPage(res.contractId); else { alert("å¤±æ•—"); hideLoading(); } }
        async function joinTeam(cid) { showLoading(); const res = await callApi("join_team", { contractId: cid }); if (res.status === "success") enterContractPage(cid); else { alert("å¤±æ•—"); showPage('view-landing'); hideLoading(); } }
        function enterContractPage(cid) { currentContractId = cid; document.getElementById('contract-id-display').innerText = cid; showPage('view-contract'); updateStatus(); if (pollingTimer) clearInterval(pollingTimer); pollingTimer = setInterval(updateStatus, 3000); }

        async function updateStatus() {
            const res = await callApi("get_status", { contractId: currentContractId });
            if (res.status !== "success") return;
            if (res.is_active) { clearInterval(pollingTimer); enterGamePage(res.game_data); return; }

            const members = res.members;
            const mySlot = members.find(m => m.name === userProfile.displayName);
            members.forEach((m, i) => {
                const img = document.querySelector(`#slot-${i} img`);
                const slot = document.getElementById(`slot-${i}`);
                if (m.exists) { img.src = m.pic || "https://placehold.co/60x60/png?text=" + m.name[0]; if (m.signed) { slot.classList.add('signed'); img.style.opacity = 1; } }
            });
            const btnInvite = document.getElementById('btn-invite');
            const btnFinger = document.getElementById('btn-finger');
            const statusTxt = document.getElementById('status-text');
            if (members.length < 2 || !members[1].exists) { btnInvite.classList.remove('hidden'); btnFinger.classList.add('hidden'); statusTxt.innerText = "ç­‰å¾…å¤¥ä¼´..."; } 
            else { btnInvite.classList.add('hidden'); if (mySlot && !mySlot.signed) { btnFinger.classList.remove('hidden'); statusTxt.innerText = "è«‹æŒ‰å£“æŒ‡ç´‹"; } else { btnFinger.classList.add('hidden'); statusTxt.innerText = "ç­‰å¾…å°æ–¹..."; } }
            hideLoading();
        }

        function enterGamePage(data) {
            hideLoading();
            showPage('view-game');
            if(data) updateGameUI(data);
            else refreshGameData(); 
            checkMsg();
        }

        async function refreshGameData() {
            const res = await callApi("get_status", { contractId: currentContractId });
            if(res.status === "success" && res.game_data) updateGameUI(res.game_data);
        }

        function updateGameUI(data) {
            gameData = data;
            // 3. æ›´æ–°è³‡è¨Šæ¬„
            document.getElementById('level-val').innerText = "Lv." + data.lv;
            document.getElementById('streak-val').innerText = data.combo;
            document.getElementById('daily-count-val').innerText = data.daily_count;
            document.getElementById('energy-val').innerText = data.energy; // æ–°å¢

            let emojiIndex = data.lv;
            if(emojiIndex >= TREE_EMOJIS.length) emojiIndex = TREE_EMOJIS.length - 1;
            document.getElementById('main-tree').innerText = TREE_EMOJIS[emojiIndex];

            const btnWater = document.getElementById('btn-water-action');
            const badge = document.getElementById('all-done-badge');
            
            // 2. åªæœ‰é»æ“Š Badge æ‰æœƒé¡¯ç¤º All Done åœ–ç‰‡
            if (data.is_all_done) {
                badge.style.display = "block"; 
            } else {
                badge.style.display = "none";
            }

            // 1. Quota åˆ¤æ–·æŒ‰éˆ•ç‹€æ…‹
            if (data.my_quota_used || data.is_all_done) {
                btnWater.className = "css-btn btn-gray"; // è®Šç°
                btnWater.innerText = data.is_all_done ? "æ˜æ—¥å†ä¾†" : "å·²æ¾†éæ°´";
            } else {
                btnWater.className = "css-btn btn-blue";
                btnWater.innerText = "ğŸ’§ æ³¨å…¥èƒ½é‡";
            }
        }

        async function triggerWatering() {
            // å‰ç«¯å…ˆæ“‹ Quota
            if(gameData.my_quota_used || gameData.is_all_done) {
                alert("ä»Šå¤©å·²ç¶“å®Œæˆä»»å‹™å›‰ï¼");
                return;
            }
            
            showPage('view-watering');
            const res = await callApi("water_tree", { contractId: currentContractId });
            
            setTimeout(() => {
                showPage('view-game');
                if (res.status === "success") {
                    updateGameUI({
                        lv: res.lv,
                        energy: res.energy,
                        daily_count: res.daily_count,
                        combo: res.combo,
                        is_all_done: res.is_all_done,
                        my_quota_used: true // æ¾†æ°´æˆåŠŸå¾Œï¼Œæˆ‘ä¹Ÿä¸èƒ½å†æ¾†äº†
                    });
                    if(res.message) alert(res.message);
                } else {
                    alert("æç¤º: " + res.message);
                }
            }, 3000);
        }

        function showAllDonePage() { showPage('view-alldone'); }
        async function checkMsg() { const res = await callApi("get_comment", { contractId: currentContractId }); if (res && res.has_msg) { hasUnread = true; pendingMsg = res.message; document.getElementById('chime-dot').classList.add('active'); } }
        function openChime() { document.getElementById('msg-modal').style.display = 'flex'; if (hasUnread) { document.getElementById('msg-read-mode').style.display = 'block'; document.getElementById('msg-write-mode').style.display = 'none'; document.getElementById('msg-text-content').innerText = pendingMsg; hasUnread = false; document.getElementById('chime-dot').classList.remove('active'); } else { document.getElementById('msg-read-mode').style.display = 'none'; document.getElementById('msg-write-mode').style.display = 'block'; } }
        async function sendMsg() { const txt = document.getElementById('msg-input').value; if(!txt) return; showLoading(); await callApi("send_comment", { contractId: currentContractId, message: txt }); hideLoading(); closeModal(); alert("å·²é€å‡º"); }
        function closeModal() { document.getElementById('msg-modal').style.display = 'none'; }
        const fingerBtn = document.getElementById('btn-finger'); let timer;
        fingerBtn.addEventListener('mousedown', startPress); fingerBtn.addEventListener('touchstart', startPress);
        fingerBtn.addEventListener('mouseup', endPress); fingerBtn.addEventListener('touchend', endPress);
        function startPress(e) { e.preventDefault(); fingerBtn.style.transform = "scale(0.9)"; timer = setTimeout(async () => { showLoading(); await callApi("sign_oath", { contractId: currentContractId }); updateStatus(); }, 1000); }
        function endPress() { clearTimeout(timer); fingerBtn.style.transform = "scale(1)"; }
        function shareInvite() { if (liff.isApiAvailable('shareTargetPicker')) { liff.shareTargetPicker([{ "type": "text", "text": `é‚€è«‹ä½ åŠ å…¥ç¾ˆçµ†ä¹‹æ£®ï¼å¥‘ç´„é€£çµï¼šhttps://liff.line.me/${LIFF_ID}?contract_id=${currentContractId}` }]); } else { alert(`è«‹è¤‡è£½: https://liff.line.me/${LIFF_ID}?contract_id=${currentContractId}`); } }
        async function callApi(action, payload) { const body = { action, userId: userProfile.userId, displayName: userProfile.displayName, ...payload }; try { const res = await fetch(GAS_API_URL, { method: "POST", mode: "cors", headers: {"Content-Type":"text/plain"}, body: JSON.stringify(body) }); return await res.json(); } catch(e) { return { status: "error" }; } }
        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function showLoading() { document.getElementById('loading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }
    </script>
</body>
</html>
